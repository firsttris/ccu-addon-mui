<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket Test f√ºr Go-Server</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        #log {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 4px;
            height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            margin-top: 15px;
        }
        .log-entry {
            margin: 5px 0;
            padding: 3px 0;
            border-bottom: 1px solid #333;
        }
        .log-send { color: #4ec9b0; }
        .log-receive { color: #ce9178; }
        .log-info { color: #569cd6; }
        .log-error { color: #f48771; }
        .status {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 3px;
            font-weight: bold;
        }
        .status.connected { background: #28a745; color: white; }
        .status.disconnected { background: #dc3545; color: white; }
        input, textarea {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        textarea { font-family: monospace; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ WebSocket Test - Go Server</h1>
        
        <div>
            <label>WebSocket URL:</label>
            <input type="text" id="wsUrl" value="ws://localhost:8088" />
        </div>

        <div style="margin: 15px 0;">
            <button id="connectBtn" onclick="connect()">Connect</button>
            <button id="disconnectBtn" onclick="disconnect()" disabled>Disconnect</button>
            <span class="status disconnected" id="status">Disconnected</span>
        </div>

        <h3>Tests:</h3>
        
        <button onclick="testSubscribe()" id="subscribeBtn" disabled>
            üìù Subscribe to Channels
        </button>
        
        <button onclick="testPlainScript()" id="scriptBtn" disabled>
            üìú Execute Plain Script
        </button>

        <button onclick="testInvalidMessage()" id="invalidBtn" disabled>
            ‚ùå Test Invalid Message
        </button>

        <button onclick="clearLog()">üóëÔ∏è Clear Log</button>

        <div>
            <h4>Custom Script:</h4>
            <textarea id="customScript" rows="3" placeholder='Write("Hello from WebSocket");'>Write("Test from WebSocket Client");</textarea>
            <button onclick="sendCustomScript()" id="customBtn" disabled>Send Script</button>
        </div>

        <div id="log"></div>
    </div>

    <script>
        let ws = null;
        const log = document.getElementById('log');

        function addLog(message, type = 'info') {
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            log.appendChild(entry);
            log.scrollTop = log.scrollHeight;
        }

        function updateStatus(connected) {
            const status = document.getElementById('status');
            const connectBtn = document.getElementById('connectBtn');
            const disconnectBtn = document.getElementById('disconnectBtn');
            const buttons = ['subscribeBtn', 'scriptBtn', 'invalidBtn', 'customBtn'];

            if (connected) {
                status.className = 'status connected';
                status.textContent = 'Connected';
                connectBtn.disabled = true;
                disconnectBtn.disabled = false;
                buttons.forEach(id => document.getElementById(id).disabled = false);
            } else {
                status.className = 'status disconnected';
                status.textContent = 'Disconnected';
                connectBtn.disabled = false;
                disconnectBtn.disabled = true;
                buttons.forEach(id => document.getElementById(id).disabled = true);
            }
        }

        function connect() {
            const url = document.getElementById('wsUrl').value;
            addLog(`Connecting to ${url}...`, 'info');

            ws = new WebSocket(url);

            ws.onopen = () => {
                addLog('‚úÖ WebSocket connected!', 'info');
                updateStatus(true);
            };

            ws.onmessage = (event) => {
                addLog(`‚¨ÖÔ∏è Received: ${event.data}`, 'receive');
                try {
                    const data = JSON.parse(event.data);
                    if (data.type === 'subscribe_response') {
                        addLog(`‚úÖ Subscribed to ${data.channels.length} channels`, 'info');
                    } else if (data.type === 'error') {
                        addLog(`‚ùå Error: ${data.error}`, 'error');
                    }
                } catch (e) {
                    // Plain text response
                    addLog(`üìÑ Plain response received`, 'info');
                }
            };

            ws.onerror = (error) => {
                addLog(`‚ùå WebSocket error: ${error}`, 'error');
            };

            ws.onclose = () => {
                addLog('üîå WebSocket disconnected', 'info');
                updateStatus(false);
            };
        }

        function disconnect() {
            if (ws) {
                ws.close();
                ws = null;
            }
        }

        function testSubscribe() {
            const message = {
                type: 'subscribe',
                deviceId: 'test-device-123',
                channels: ['BidCos-RF.ABC123:1', 'BidCos-RF.ABC123:2'],
                requestId: 'req-' + Date.now()
            };
            const json = JSON.stringify(message, null, 2);
            addLog(`‚û°Ô∏è Sending subscribe: ${json}`, 'send');
            ws.send(JSON.stringify(message));
        }

        function testPlainScript() {
            const script = 'Write("Hello from WebSocket Test");';
            addLog(`‚û°Ô∏è Sending plain script: ${script}`, 'send');
            ws.send(script);
        }

        function sendCustomScript() {
            const script = document.getElementById('customScript').value;
            if (!script.trim()) {
                alert('Please enter a script!');
                return;
            }
            addLog(`‚û°Ô∏è Sending custom script: ${script}`, 'send');
            ws.send(script);
        }

        function testInvalidMessage() {
            const message = { type: 'unknown_type', data: 'test' };
            addLog(`‚û°Ô∏è Sending invalid message: ${JSON.stringify(message)}`, 'send');
            ws.send(JSON.stringify(message));
        }

        function clearLog() {
            log.innerHTML = '';
        }

        // Auto-connect on load
        window.addEventListener('load', () => {
            addLog('üöÄ WebSocket Tester loaded. Click "Connect" to start.', 'info');
        });
    </script>
</body>
</html>
