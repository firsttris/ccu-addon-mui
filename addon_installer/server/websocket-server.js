#!/usr/bin/env node
import{WebSocketServer as x,WebSocket as h}from"ws";import{createServer as W}from"http";import*as K from"homematic-xmlrpc";import*as $ from"homematic-rega";var L=8088,O=2001,_=2010,I="localhost",X=W(),M=new x({server:X}),G=new Set,P=new $.Rega({host:I,port:8181}),F,V={};function U(){F=K.createServer({host:"127.0.0.1",port:9099}),F.on("system.multicall",function(q,z,y){z[0].forEach(function(A){Z(A.params[0],A.params[1],A.params[2],A.params[3])}),y(null,"")}),F.on("event",function(q,z,y){Z(z[0],z[1],z[2],z[3]),y(null,"")}),F.on("newDevices",function(q,z,y){console.log("New devices detected"),y(null,"")}),F.on("deleteDevices",function(q,z,y){console.log("Devices deleted"),y(null,"")}),Y("BidCos-RF",O),Y("HmIP-RF",_),console.log("RPC Server started on port 9099")}function Y(q,z){let y=K.createClient({host:I,port:z});V[q]=y,y.methodCall("init",["http://127.0.0.1:9099",q],function(A){if(A)console.error(`Failed to initialize ${q}:`,A.message);else console.log(`Connected to ${q} on port ${z}`)})}function Z(q,z,y,A){let B={event:{interface:q,channel:z,datapoint:y,value:A,timestamp:new Date().toISOString()}};k(B)}function k(q){let z=JSON.stringify(q);G.forEach((y)=>{if(y.readyState===h.OPEN)y.send(z)})}async function Q(q){return new Promise((z,y)=>{P.script(q,function(A,B){if(A)y(A);else z(B)})})}M.on("connection",(q)=>{console.log("New WebSocket client connected"),G.add(q),q.on("message",async(z)=>{try{let y=z.toString(),A=!1,B;try{B=JSON.parse(y),A=!0}catch{A=!1}if(A){if(B.type==="script"){let D=await Q(B.script);q.send(JSON.stringify({type:"script_response",result:D,requestId:B.requestId}))}else if(B.type==="setValue"){let{address:D,datapoint:j,value:E}=B,H=`dom.GetObject("${D}").DPByHssDP("${j}").State(${E});`,J=await Q(H);q.send(JSON.stringify({type:"setValue_response",result:J,requestId:B.requestId}))}}else{let D=await Q(y);q.send(JSON.stringify(D))}}catch(y){console.error("Error handling message:",y),q.send(JSON.stringify({type:"error",error:y instanceof Error?y.message:String(y)}))}}),q.on("close",()=>{console.log("WebSocket client disconnected"),G.delete(q)}),q.on("error",(z)=>{console.error("WebSocket error:",z),G.delete(q)})});X.listen(L,()=>{console.log(`WebSocket Server running on port ${L}`),console.log(`WebSocket URL: ws://localhost:${L}`)});U();process.on("SIGTERM",()=>{console.log("Shutting down..."),Object.keys(V).forEach((q)=>{V[q].methodCall("init",["http://127.0.0.1:9099",""],(z)=>{if(z)console.error(`Failed to unregister ${q}:`,z.message)})}),M.close(),X.close(),process.exit(0)});process.on("SIGINT",()=>{console.log("Shutting down..."),process.exit(0)});

//# debugId=EAD3B22160ADAA8E64756E2164756E21
//# sourceMappingURL=websocket-server.js.map
