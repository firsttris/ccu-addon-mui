#!/bin/sh

ADDON_DIR=/usr/local/addons/mui
RC_DIR=/usr/local/etc/config/rc.d
WWW_DIR=/usr/local/etc/config/addons/www

mount | grep /usr/local 2>&1 >/dev/null
if [ $? -eq 1 ]; then
  mount /usr/local
fi

mkdir -p $ADDON_DIR && chmod -R 755 $ADDON_DIR
cp -af dist/* $ADDON_DIR

# Copy Node.js binary
mkdir -p $ADDON_DIR/node
cp -af node/* $ADDON_DIR/node/
chmod +x $ADDON_DIR/node/bin/node
chmod +x $ADDON_DIR/node/bin/npm

# Copy WebSocket server (bundled JS + package.json for dependencies)
mkdir -p $ADDON_DIR/server
cp -af server/websocket-server.js $ADDON_DIR/server/
cp -af server/package.json $ADDON_DIR/server/
chmod +x $ADDON_DIR/server/websocket-server.js

# Create symlink only if it doesn't exist
if [ ! -L $WWW_DIR/mui ]; then
  ln -sf $ADDON_DIR $WWW_DIR/mui
fi

cp -af rc.d/mui $RC_DIR/
chmod +x $RC_DIR/mui

# Copy version file if it exists
if [ -f VERSION ]; then
  cp -af VERSION $ADDON_DIR/
fi

# Copy update-check CGI script
if [ -f www/update-check.cgi ]; then
  mkdir -p $ADDON_DIR/www
  cp -af www/update-check.cgi $ADDON_DIR/www/
  chmod +x $ADDON_DIR/www/update-check.cgi
fi

cp -af lighttpd.conf /usr/local/etc/config/lighttpd/mui.conf

# Reload lighttpd configuration
if [ -x /etc/init.d/S50lighttpd ]; then
  /etc/init.d/S50lighttpd reload
fi

# Install only production dependencies on CCU3
echo "Installing server dependencies..."
cd $ADDON_DIR/server
if ! $ADDON_DIR/node/bin/npm install --production --omit=dev 2>&1; then
  echo "ERROR: Failed to install dependencies"
  exit 1
fi

# Start the WebSocket server
$RC_DIR/mui start

sync

exit 0