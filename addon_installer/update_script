#!/bin/sh

ADDON_DIR=/usr/local/addons/mui
RC_DIR=/usr/local/etc/config/rc.d
WWW_DIR=/usr/local/etc/config/addons/www

mount | grep /usr/local 2>&1 >/dev/null
if [ $? -eq 1 ]; then
  mount /usr/local
fi

mkdir -p $ADDON_DIR && chmod -R 755 $ADDON_DIR

# Copy CGI script first (directly to addon root)
if [ -f update-check.cgi ]; then
  cp -af update-check.cgi $ADDON_DIR/update-check.cgi
  chmod +x $ADDON_DIR/update-check.cgi
fi

# Copy React app to addon directory
cp -af dist/* $ADDON_DIR/

# Cleanup old Node.js server files (migration from old version)
if [ -d "$ADDON_DIR/node" ]; then
  rm -rf $ADDON_DIR/node
fi
if [ -d "$ADDON_DIR/server" ]; then
  rm -rf $ADDON_DIR/server
fi

# Copy Go server binary
mkdir -p $ADDON_DIR/go-server
cp -af go-server/ccu-addon-mui-server-arm $ADDON_DIR/go-server/ccu-addon-mui-server
chmod +x $ADDON_DIR/go-server/ccu-addon-mui-server

# Create symlink only if it doesn't exist
if [ ! -L $WWW_DIR/mui ]; then
  ln -sf $ADDON_DIR $WWW_DIR/mui
fi

cp -af rc.d/mui $RC_DIR/
chmod +x $RC_DIR/mui

# Copy version file if it exists
if [ -f VERSION ]; then
  cp -af VERSION $ADDON_DIR/
fi

cp -af lighttpd.conf /usr/local/etc/config/lighttpd/mui.conf

sync

exit 0